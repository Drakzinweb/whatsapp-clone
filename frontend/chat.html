<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - WhatsApp Clone</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            whatsapp: {
              light: '#e2f7cb',
              DEFAULT: '#dcf8c6',
              dark: '#128c7e',
              darker: '#075e54'
            }
          }
        }
      }
    }
  </script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  
  <!-- Custom Styles -->
  <style>
    .chat-bubble {
      max-width: 70%;
      word-wrap: break-word;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      position: relative;
      margin: 0.5rem 0;
      animation: fadeIn 0.2s ease-out;
    }
    
    .chat-bubble.sent {
      background-color: #dcf8c6;
      align-self: flex-end;
      border-top-right-radius: 0.25rem;
    }
    
    .chat-bubble.received {
      background-color: white;
      align-self: flex-start;
      border-top-left-radius: 0.25rem;
    }
    
    .user-item:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    
    .user-item.active {
      background-color: #ebebeb;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #666;
      border-radius: 50%;
      margin: 0 2px;
      opacity: 0.4;
    }
    
    .typing-indicator span:nth-child(1) {
      animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation: typing 1s infinite 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation: typing 1s infinite 0.4s;
    }
    
    @keyframes typing {
      0%, 100% {
        opacity: 0.4;
        transform: translateY(0);
      }
      50% {
        opacity: 1;
        transform: translateY(-3px);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-time {
      font-size: 0.7rem;
      color: #666;
      margin-top: 0.25rem;
      text-align: right;
    }
    
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans h-screen flex items-center justify-center">
  <div class="flex h-[90vh] w-[90vw] shadow-2xl rounded-xl overflow-hidden">
    <!-- Sidebar -->
    <div class="w-1/3 bg-white flex flex-col border-r border-gray-200">
      <!-- Header -->
      <div class="bg-whatsapp-darker text-white p-4 flex items-center">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-3">
          <i class="fas fa-user text-gray-600"></i>
        </div>
        <div class="flex-1">
          <h2 class="font-semibold">Meu Perfil</h2>
          <p class="text-xs opacity-80">Online</p>
        </div>
        <div class="flex space-x-4">
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-search"></i>
          </button>
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-ellipsis-vertical"></i>
          </button>
        </div>
      </div>
      
      <!-- Search -->
      <div class="p-2 bg-whatsapp-dark">
        <div class="bg-white rounded-lg flex items-center px-3 py-1">
          <i class="fas fa-search text-gray-500 mr-2"></i>
          <input type="text" placeholder="Pesquisar ou começar nova conversa" 
                 class="flex-1 py-1 text-sm outline-none">
        </div>
      </div>
      
      <!-- Chats List -->
      <div class="flex-1 overflow-y-auto scrollbar-hide" id="usersList">
        <!-- Users will be populated by JavaScript -->
      </div>
    </div>
    
    <!-- Chat Area -->
    <div class="w-2/3 flex flex-col bg-gray-50">
      <!-- Chat Header -->
      <div class="bg-whatsapp-dark text-white p-3 flex items-center justify-between border-b border-gray-200">
        <div class="flex items-center">
          <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-3">
            <i class="fas fa-user text-gray-600"></i>
          </div>
          <div>
            <h2 id="chatWith" class="font-semibold">Selecione um contato</h2>
            <div id="typingIndicator" class="typing-indicator hidden">
              <span></span>
              <span></span>
              <span></span>
              <span class="text-xs">digitando...</span>
            </div>
          </div>
        </div>
        <div class="flex space-x-4">
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-search"></i>
          </button>
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-phone"></i>
          </button>
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-video"></i>
          </button>
          <button class="text-white opacity-80 hover:opacity-100">
            <i class="fas fa-ellipsis-vertical"></i>
          </button>
        </div>
      </div>
      
      <!-- Messages -->
      <div id="messages" class="flex-1 p-4 overflow-y-auto scrollbar-hide bg-[#e5ddd5] bg-opacity-30 bg-[url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png')]">
        <!-- Messages will be populated by JavaScript -->
      </div>
      
      <!-- Message Input -->
      <div class="bg-white p-3 flex items-center border-t border-gray-200">
        <div class="flex space-x-2 mr-2">
          <button class="text-gray-500 hover:text-gray-700 w-10 h-10 rounded-full flex items-center justify-center">
            <i class="far fa-face-smile"></i>
          </button>
          <button class="text-gray-500 hover:text-gray-700 w-10 h-10 rounded-full flex items-center justify-center">
            <i class="fas fa-paperclip"></i>
          </button>
        </div>
        <form id="msgForm" class="flex-1 flex">
          <input id="msgInput" 
                 type="text" 
                 placeholder="Selecione um usuário para conversar"
                 class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-gray-800 focus:outline-none"
                 autocomplete="off"
                 disabled />
          <button type="submit" 
                  class="ml-2 w-10 h-10 rounded-full bg-whatsapp-dark text-white flex items-center justify-center">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const socketUrl = 'https://whatsapp-clone-oz95.onrender.com'; // backend real
      const token = localStorage.getItem('token');
      
      if (!token) {
        alert('Usuário não autenticado! Faça login.');
        window.location.href = '/login.html';
      }
      
      const socket = io(socketUrl, {
        auth: { token }
      });
      
      const usersList = document.getElementById('usersList');
      const chatWith = document.getElementById('chatWith');
      const messagesContainer = document.getElementById('messages');
      const msgForm = document.getElementById('msgForm');
      const msgInput = document.getElementById('msgInput');
      
      let currentChatUser = null;
      
      socket.on('onlineUsers', (users) => {
        usersList.innerHTML = '';
        users.forEach(userId => {
          if (userId === getUserIdFromToken(token)) return;
          
          const userItem = document.createElement('div');
          userItem.className = 'user-item p-3 flex items-center border-b border-gray-100';
          
          const userAvatar = document.createElement('div');
          userAvatar.className = 'relative mr-3';
          
          const avatarIcon = document.createElement('div');
          avatarIcon.className = 'w-12 h-12 rounded-full bg-green-200 flex items-center justify-center';
          avatarIcon.innerHTML = '<i class="fas fa-user text-green-600"></i>';
          
          const onlineStatus = document.createElement('span');
          onlineStatus.className = 'absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
          
          userAvatar.appendChild(avatarIcon);
          userAvatar.appendChild(onlineStatus);
          
          const userInfo = document.createElement('div');
          userInfo.className = 'flex-1';
          
          const userHeader = document.createElement('div');
          userHeader.className = 'flex justify-between items-center';
          
          const userName = document.createElement('h3');
          userName.className = 'font-semibold';
          userName.textContent = `Usuário ${userId}`;
          
          userHeader.appendChild(userName);
          
          userInfo.appendChild(userHeader);
          userItem.appendChild(userAvatar);
          userItem.appendChild(userInfo);
          
          userItem.addEventListener('click', () => startChat(userId));
          
          usersList.appendChild(userItem);
        });
      });
      
      socket.on('history', (msgs) => {
        messagesContainer.innerHTML = '';
        msgs.forEach(msg => renderMessage(msg));
      });
      
      socket.on('message', (msg) => {
        const userId = getUserIdFromToken(token);
        if ((msg.from === currentChatUser && msg.to === userId) ||
            (msg.to === currentChatUser && msg.from === userId)) {
          renderMessage(msg);
        }
      });
      
      msgForm.addEventListener('submit', e => {
        e.preventDefault();
        const text = msgInput.value.trim();
        if (!text || !currentChatUser) return;
        
        socket.emit('message', { to: currentChatUser, text });
        msgInput.value = '';
      });
      
      function startChat(userId) {
        currentChatUser = userId;
        chatWith.textContent = `Usuário: ${userId}`;
        messagesContainer.innerHTML = '';
        msgInput.disabled = false;
        msgInput.placeholder = "Digite uma mensagem";
        socket.emit('join', { to: userId });
      }
      
      function renderMessage(msg) {
        const isMe = msg.from === getUserIdFromToken(token);
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-bubble ${isMe ? 'sent' : 'received'}`;
        
        const messageContent = document.createElement('p');
        messageContent.textContent = msg.text;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        
        const timestamp = new Date(msg.timestamp);
        const hours = timestamp.getHours().toString().padStart(2, '0');
        const minutes = timestamp.getMinutes().toString().padStart(2, '0');
        messageTime.textContent = `${hours}:${minutes} ${isMe ? '✓✓' : ''}`;
        
        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(messageTime);
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      function getUserIdFromToken(token) {
        try {
          const payload = token.split('.')[1];
          const decoded = JSON.parse(atob(payload));
          return decoded.id;
        } catch {
          return null;
        }
      }
    });
  </script>
</body>
</html>