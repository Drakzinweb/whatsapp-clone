<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech Chat Pro</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
  <!-- Emoji Picker -->
  <script src="https://cdn.jsdelivr.net/npm/@emoji-mart/react"></script>
  
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Animation for new messages */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-animation {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Typing indicator animation */
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #6b7280;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    /* Modal animations */
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-animation {
      animation: modalFadeIn 0.3s ease-out;
    }
    
    /* Video call styles */
    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: #000;
    }
    
    .video-remote {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-local {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 30%;
      max-width: 200px;
      border: 2px solid white;
      border-radius: 8px;
      z-index: 10;
    }
    
    .call-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 10;
    }
    
    .call-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }
    
    /* Stories styles */
    .story-container {
      display: flex;
      padding: 10px;
      overflow-x: auto;
      gap: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .story-item {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      padding: 2px;
      cursor: pointer;
    }
    
    .story-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .story-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .story-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.9);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .story-viewer img {
      max-width: 100%;
      max-height: 80%;
      object-fit: contain;
    }
    
    .story-progress {
      width: 100%;
      height: 3px;
      background-color: rgba(255,255,255,0.3);
      margin-bottom: 20px;
    }
    
    .story-progress-bar {
      height: 100%;
      background-color: white;
      width: 0%;
      transition: width 0.1s linear;
    }
    
    /* Emoji reactions */
    .reaction-btn {
      position: absolute;
      right: -10px;
      top: -10px;
      background: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 1;
    }
    
    .message-container:hover .reaction-btn {
      display: flex;
    }
    
    .reactions-container {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 20px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 10;
    }
    
    .reaction-emoji {
      font-size: 20px;
      margin: 0 3px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .reaction-emoji:hover {
      transform: scale(1.3);
    }
    
    .message-reaction {
      position: absolute;
      bottom: -10px;
      right: -5px;
      font-size: 14px;
      background: white;
      border-radius: 10px;
      padding: 2px 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    /* Self-destruct timer */
    .self-destruct-timer {
      position: absolute;
      bottom: -15px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      color: #ef4444;
    }
    
    /* Pinned message */
    .pinned-message {
      background-color: #f0f9ff;
      border-left: 3px solid #3b82f6;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 0 8px 8px 0;
    }
    
    .pinned-label {
      font-size: 12px;
      color: #3b82f6;
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      #usersListContainer {
        display: block;
      }
      #chatArea {
        display: none;
      }
      #backToContacts {
        display: flex;
      }
      
      .video-local {
        width: 40%;
      }
    }
    
    @media (min-width: 769px) {
      #usersListContainer {
        display: block;
      }
      #chatArea {
        display: flex;
      }
      #backToContacts {
        display: none;
      }
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-animation">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Perfil do Usuário</h3>
          <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="flex flex-col items-center mb-6">
          <div class="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center mb-4">
            <i class="fas fa-user text-3xl text-indigo-600"></i>
          </div>
          <h4 id="profileUsername" class="text-lg font-semibold text-gray-800">Nome do Usuário</h4>
          <p id="profileStatus" class="text-sm text-gray-500">Online</p>
        </div>
        
        <div class="space-y-3">
          <button id="blockUserBtn" class="w-full flex items-center justify-between p-3 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition">
            <span>Bloquear Usuário</span>
            <i class="fas fa-ban"></i>
          </button>
          
          <button class="w-full flex items-center justify-between p-3 rounded-lg bg-gray-50 text-gray-600 hover:bg-gray-100 transition">
            <span>Silenciar Notificações</span>
            <i class="fas fa-bell-slash"></i>
          </button>
          
          <button class="w-full flex items-center justify-between p-3 rounded-lg bg-gray-50 text-gray-600 hover:bg-gray-100 transition">
            <span>Arquivar Conversa</span>
            <i class="fas fa-archive"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Block Confirmation Modal -->
  <div id="blockConfirmModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-animation">
      <div class="p-6">
        <div class="flex justify-center mb-4">
          <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
          </div>
        </div>
        
        <h3 class="text-xl font-bold text-center text-gray-800 mb-2">Confirmar Bloqueio</h3>
        <p id="blockConfirmText" class="text-gray-600 text-center mb-6">Você tem certeza que deseja bloquear este usuário?</p>
        
        <div class="flex space-x-3">
          <button id="cancelBlockBtn" class="flex-1 py-2 px-4 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
            Cancelar
          </button>
          <button id="confirmBlockBtn" class="flex-1 py-2 px-4 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Call Modal -->
  <div id="videoCallModal" class="fixed inset-0 z-50 hidden bg-black">
    <div class="video-container">
      <video id="remoteVideo" class="video-remote" autoplay playsinline></video>
      <video id="localVideo" class="video-local" autoplay playsinline muted></video>
      
      <div class="call-controls">
        <button id="endCallBtn" class="call-btn bg-red-600 text-white">
          <i class="fas fa-phone-slash"></i>
        </button>
        <button id="muteCallBtn" class="call-btn bg-gray-600 text-white">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="videoToggleBtn" class="call-btn bg-gray-600 text-white">
          <i class="fas fa-video"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingCallModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
      <div class="w-20 h-20 rounded-full bg-indigo-100 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-video text-3xl text-indigo-600"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-1">Chamada de Vídeo</h3>
      <p id="incomingCallFrom" class="text-gray-600 mb-6">De: Usuário</p>
      
      <div class="flex justify-center space-x-4">
        <button id="declineCallBtn" class="w-14 h-14 rounded-full bg-red-600 text-white flex items-center justify-center">
          <i class="fas fa-phone-slash text-xl"></i>
        </button>
        <button id="acceptCallBtn" class="w-14 h-14 rounded-full bg-green-600 text-white flex items-center justify-center">
          <i class="fas fa-video text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Story Viewer -->
  <div id="storyViewer" class="story-viewer hidden">
    <div class="story-progress">
      <div class="story-progress-bar"></div>
    </div>
    <img id="storyImage" src="" alt="Story">
    <button id="closeStoryBtn" class="absolute top-4 right-4 text-white text-2xl">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Create Story Modal -->
  <div id="createStoryModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-animation">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Criar Story</h3>
          <button id="closeCreateStoryModal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="mb-6">
          <div id="storyPreview" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden hidden">
            <img id="storyPreviewImage" src="" alt="Preview" class="w-full h-full object-cover">
          </div>
          <div id="storyUploadPlaceholder" class="w-full h-64 bg-gray-100 rounded-lg flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-gray-300">
            <i class="fas fa-camera text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-500">Clique para adicionar foto ou vídeo</p>
          </div>
        </div>
        
        <input type="file" id="storyFileInput" accept="image/*,video/*" class="hidden">
        
        <button id="postStoryBtn" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition disabled:opacity-50" disabled>
          Publicar Story
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for media messages -->
  <input type="file" id="mediaFileInput" accept="image/*,video/*" class="hidden">

  <div id="app" class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <div id="usersListContainer" class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col">
      <!-- User profile header -->
      <div class="p-4 bg-indigo-600 text-white flex items-center justify-between">
        <div class="flex items-center">
          <button id="openProfileBtn" class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center mr-3">
            <i class="fas fa-user text-xl"></i>
          </button>
          <div>
            <h2 id="currentUsername" class="font-semibold">Usuário</h2>
            <p class="text-xs opacity-80">Online</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <button id="createStoryBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-plus-circle"></i>
          </button>
          <button id="settingsBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-cog"></i>
          </button>
          <button id="logoutBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
      
      <!-- Stories -->
      <div id="storiesContainer" class="story-container">
        <!-- Stories will be populated here -->
      </div>
      
      <!-- Search bar -->
      <div class="p-3 border-b border-gray-200">
        <div class="relative">
          <input 
            type="text"
            placeholder="Buscar contatos..."
            class="w-full pl-10 pr-4 py-2 rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            id="searchInput"
          />
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
      </div>
      
      <!-- Contacts list -->
      <div class="flex-1 overflow-y-auto">
        <h3 class="px-4 py-2 text-sm font-medium text-gray-500 uppercase tracking-wider">Contatos</h3>
        <ul id="usersList" class="divide-y divide-gray-200"></ul>
      </div>
    </div>
    
    <!-- Chat area -->
    <div id="chatArea" class="flex-1 flex flex-col bg-white">
      <!-- Chat header with back button for mobile -->
      <div id="chatHeader" class="p-4 bg-indigo-600 text-white flex items-center justify-between">
        <div class="flex items-center">
          <button id="backToContacts" class="mr-2 text-white hover:text-gray-200 transition md:hidden">
            <i class="fas fa-arrow-left"></i>
          </button>
          <button id="openChatProfileBtn" class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center mr-3">
              <i class="fas fa-user text-xl"></i>
            </div>
            <div>
              <h2 id="chatTitle" class="font-semibold">Selecione um contato</h2>
              <p id="typingIndicator" class="text-xs opacity-80"></p>
            </div>
          </button>
        </div>
        <div class="flex items-center space-x-3">
          <button id="startAudioCallBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-phone"></i>
          </button>
          <button id="startVideoCallBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-video"></i>
          </button>
          <button id="chatOptionsBtn" class="text-white hover:text-gray-200 transition">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </div>
      
      <!-- Pinned message -->
      <div id="pinnedMessageContainer" class="pinned-message hidden">
        <div class="pinned-label">
          <i class="fas fa-thumbtack mr-1"></i>
          Mensagem fixada
        </div>
        <div id="pinnedMessageContent"></div>
      </div>
      
      <!-- Messages container -->
      <div id="messages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
        <div class="text-center text-gray-500 text-sm py-8">
          Selecione um contato para começar a conversar
        </div>
      </div>
      
      <!-- Message input -->
      <div class="p-4 border-t border-gray-200 bg-white">
        <form id="msgForm" class="flex items-center space-x-2" autocomplete="off">
          <button type="button" id="attachMediaBtn" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition flex items-center justify-center">
            <i class="fas fa-paperclip"></i>
          </button>
          <div class="relative flex-1">
            <input
              id="msgInput"
              type="text"
              placeholder="Digite uma mensagem..."
              class="w-full px-4 py-2 rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              autocomplete="off"
            />
            <button type="button" id="selfDestructBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-indigo-600">
              <i class="fas fa-clock"></i>
            </button>
          </div>
          <button type="submit" id="sendBtn" class="w-10 h-10 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition flex items-center justify-center">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    (async function() {
      // ===== Authentication check =====
      const token    = localStorage.getItem('token');
      const userId   = localStorage.getItem('userId');
      const username = localStorage.getItem('username');
      
      // Se faltar algum dado de auth, redireciona
      if (!token || !userId || !username) {
        window.location.href = 'login.html';
        return;  // interrompe a execução deste script
      }
      
      // **AQUI** você já tem a variável `username` válida:
      document.getElementById('currentUsername').textContent = username;
      
      // Logout
      document.getElementById('logoutBtn').onclick = () => {
        localStorage.clear();
        window.location.href = 'login.html';
      };
      
      // Settings button
      document.getElementById('settingsBtn').onclick = () => {
        window.location.href = 'config.html';
      };
      
      // Back to contacts button (mobile)
      document.getElementById('backToContacts').addEventListener('click', () => {
        document.getElementById('usersListContainer').style.display = 'block';
        document.getElementById('chatArea').style.display = 'none';
      });
      
      // ===== Profile Modal =====
      const profileModal = document.getElementById('profileModal');
      const openProfileBtn = document.getElementById('openProfileBtn');
      const openChatProfileBtn = document.getElementById('openChatProfileBtn');
      const closeProfileModal = document.getElementById('closeProfileModal');
      const blockUserBtn = document.getElementById('blockUserBtn');
      const blockConfirmModal = document.getElementById('blockConfirmModal');
      const cancelBlockBtn = document.getElementById('cancelBlockBtn');
      const confirmBlockBtn = document.getElementById('confirmBlockBtn');
      const blockConfirmText = document.getElementById('blockConfirmText');
      const chatOptionsBtn = document.getElementById('chatOptionsBtn');
      
      let currentProfileUserId = null;
      
      // Open profile modal for current user
      openProfileBtn.addEventListener('click', () => {
        document.getElementById('profileUsername').textContent = username;
        document.getElementById('profileStatus').textContent = 'Online';
        blockUserBtn.style.display = 'none';
        currentProfileUserId = null;
        profileModal.classList.remove('hidden');
      });
      
      // Open profile modal for chat user
      openChatProfileBtn.addEventListener('click', () => {
        if (currentChatUserId) {
          document.getElementById('profileUsername').textContent = currentChatUsername;
          document.getElementById('profileStatus').textContent = 'Online';
          blockUserBtn.style.display = 'flex';
          currentProfileUserId = currentChatUserId;
          profileModal.classList.remove('hidden');
        }
      });
      
      // Chat options button
      chatOptionsBtn.addEventListener('click', () => {
        if (currentChatUserId) {
          document.getElementById('profileUsername').textContent = currentChatUsername;
          document.getElementById('profileStatus').textContent = 'Online';
          blockUserBtn.style.display = 'flex';
          currentProfileUserId = currentChatUserId;
          profileModal.classList.remove('hidden');
        }
      });
      
      // Close profile modal
      closeProfileModal.addEventListener('click', () => {
        profileModal.classList.add('hidden');
      });
      
      // Block user button
      blockUserBtn.addEventListener('click', () => {
        profileModal.classList.add('hidden');
        blockConfirmText.textContent = `Você tem certeza que deseja bloquear ${currentChatUsername}?`;
        blockConfirmModal.classList.remove('hidden');
      });
      
      // Cancel block
      cancelBlockBtn.addEventListener('click', () => {
        blockConfirmModal.classList.add('hidden');
        profileModal.classList.remove('hidden');
      });
      
      // Confirm block
      confirmBlockBtn.addEventListener('click', async () => {
        try {
          const res = await fetch(
            `https://whatsapp-clone-wwjc.onrender.com/api/users/${currentProfileUserId}/block`,
            {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message);
          
          // UI updates
          blockConfirmModal.classList.add('hidden');
          profileModal.classList.add('hidden');
          
          // Remove da lista
          const blockedEl = document.querySelector(`li[data-id="${currentProfileUserId}"]`);
          if (blockedEl) blockedEl.remove();
          
          // Se estiver conversando, fecha chat
          if (currentChatUserId === currentProfileUserId) {
            currentChatUserId = null;
            chatTitle.textContent = 'Selecione um contato';
            messagesContainer.innerHTML = `
              <div class="text-center text-gray-500 text-sm py-8">
                Selecione um contato para começar a conversar
              </div>
            `;
            if (window.innerWidth <= 768) {
              usersListContainer.style.display = 'block';
              chatArea.style.display = 'none';
            }
          }
          
          // Notificação
          const n = document.createElement('div');
          n.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center';
          n.innerHTML = `<i class="fas fa-check-circle mr-2"></i><span>${currentChatUsername} bloqueado</span>`;
          document.body.appendChild(n);
          setTimeout(() => { n.remove(); }, 3000);
          
        } catch (err) {
          alert('Erro ao bloquear: ' + err.message);
        }
      });
      
      // ===== Socket.IO connection =====
      const socket = io('https://whatsapp-clone-wwjc.onrender.com', {
        auth: { token },
        path: '/socket.io',
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000
      });
      
      // Tratamento de erros de conexão
      socket.on('connect_error', (err) => {
        console.error('Erro de conexão:', err.message);
        
        // Tentar reconectar antes de redirecionar
        setTimeout(() => {
          if (!socket.connected) {
            alert('Não foi possível conectar ao servidor. Por favor, tente novamente.');
            localStorage.clear();
            window.location.href = 'login.html';
          }
        }, 5000);
      });
      
      // Quando a conexão é estabelecida
      socket.on('connect', () => {
        console.log('Conectado ao servidor Socket.IO');
        
        // Enviar autenticação novamente após reconexão
        socket.emit('authenticate', { token });
      });
      
      // Tratamento de autenticação falha
      socket.on('unauthorized', (err) => {
        console.error('Autenticação falhou:', err.message);
        alert('Sessão expirada. Por favor, faça login novamente.');
        localStorage.clear();
        window.location.href = 'login.html';
      });
      
      // ===== UI elements =====
      const usersList = document.getElementById('usersList');
      const chatTitle = document.getElementById('chatTitle');
      const messagesContainer = document.getElementById('messages');
      const typingIndicator = document.getElementById('typingIndicator');
      const msgForm = document.getElementById('msgForm');
      const msgInput = document.getElementById('msgInput');
      const searchInput = document.getElementById('searchInput');
      const usersListContainer = document.getElementById('usersListContainer');
      const chatArea = document.getElementById('chatArea');
      const pinnedMessageContainer = document.getElementById('pinnedMessageContainer');
      const pinnedMessageContent = document.getElementById('pinnedMessageContent');
      
      let currentChatUserId = null;
      let currentChatUsername = null;
      let typingTimeout;
      let onlineUsers = [];
      let selfDestructEnabled = false;
      let selfDestructSeconds = 10;
      
      // ===== Media Messages =====
      const mediaFileInput = document.getElementById('mediaFileInput');
      const attachMediaBtn = document.getElementById('attachMediaBtn');
      
      attachMediaBtn.addEventListener('click', () => {
        mediaFileInput.click();
      });
      
      mediaFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64 = event.target.result;
          const type = file.type.split('/')[0]; // 'image' or 'video'
          
          if (currentChatUserId) {
            socket.emit('mediaMessage', {
              to: currentChatUserId,
              base64,
              type,
              selfDestruct: selfDestructEnabled ? selfDestructSeconds : null
            });
            
            // Reset self-destruct settings
            selfDestructEnabled = false;
            document.getElementById('selfDestructBtn').classList.remove('text-indigo-600');
          }
        };
        reader.readAsDataURL(file);
      });
      
      // ===== Self-Destruct Messages =====
      const selfDestructBtn = document.getElementById('selfDestructBtn');
      
      selfDestructBtn.addEventListener('click', () => {
        selfDestructEnabled = !selfDestructEnabled;
        
        if (selfDestructEnabled) {
          selfDestructBtn.classList.add('text-indigo-600');
          
          // Show options modal
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50';
          modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 modal-animation">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Mensagem autodestrutiva</h3>
              <p class="text-gray-600 mb-4">Selecione o tempo após o qual a mensagem será apagada:</p>
              
              <div class="grid grid-cols-3 gap-2 mb-6">
                ${[5, 10, 30, 60, 300, 3600].map(sec => {
                  const mins = Math.floor(sec / 60);
                  const displayText = sec < 60 ? `${sec} segundos` : 
                                    sec === 60 ? '1 minuto' : 
                                    `${mins} minutos`;
                  return `
                    <button 
                      class="py-2 px-3 rounded-lg border ${selfDestructSeconds === sec ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}"
                      data-seconds="${sec}"
                    >
                      ${displayText}
                    </button>
                  `;
                }).join('')}
              </div>
              
              <div class="flex space-x-3">
                <button id="cancelSelfDestructBtn" class="flex-1 py-2 px-4 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
                  Cancelar
                </button>
                <button id="confirmSelfDestructBtn" class="flex-1 py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">
                  Confirmar
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // Set seconds handler
          modal.querySelectorAll('[data-seconds]').forEach(btn => {
            btn.addEventListener('click', () => {
              selfDestructSeconds = parseInt(btn.dataset.seconds);
              modal.querySelectorAll('[data-seconds]').forEach(b => {
                b.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-700');
                b.classList.add('border-gray-300', 'text-gray-700');
              });
              btn.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-700');
              btn.classList.remove('border-gray-300', 'text-gray-700');
            });
          });
          
          // Cancel handler
          modal.querySelector('#cancelSelfDestructBtn').addEventListener('click', () => {
            selfDestructEnabled = false;
            selfDestructBtn.classList.remove('text-indigo-600');
            modal.remove();
          });
          
          // Confirm handler
          modal.querySelector('#confirmSelfDestructBtn').addEventListener('click', () => {
            modal.remove();
          });
        } else {
          selfDestructBtn.classList.remove('text-indigo-600');
        }
      });
      
      // ===== Message Reactions =====
      function setupReactionButtons(messageElement, messageId) {
        const reactionBtn = messageElement.querySelector('.reaction-btn');
        const reactionsContainer = messageElement.querySelector('.reactions-container');
        
        reactionBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          reactionsContainer.style.display = reactionsContainer.style.display === 'flex' ? 'none' : 'flex';
        });
        
        // Add reaction handlers
        reactionsContainer.querySelectorAll('.reaction-emoji').forEach(emojiBtn => {
          emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            socket.emit('react', {
              messageId,
              emoji: emojiBtn.textContent
            });
            reactionsContainer.style.display = 'none';
          });
        });
        
        // Close reactions when clicking outside
        document.addEventListener('click', (e) => {
          if (!messageElement.contains(e.target)) {
            reactionsContainer.style.display = 'none';
          }
        });
      }
      
      // ===== Pinned Messages =====
      function setupPinButton(messageElement, messageId) {
        const pinBtn = messageElement.querySelector('.pin-btn');
        if (pinBtn) {
          pinBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            socket.emit('pinMessage', { messageId });
          });
        }
      }
      
      // ===== Stories =====
      const storiesContainer = document.getElementById('storiesContainer');
      const createStoryBtn = document.getElementById('createStoryBtn');
      const createStoryModal = document.getElementById('createStoryModal');
      const closeCreateStoryModal = document.getElementById('closeCreateStoryModal');
      const storyUploadPlaceholder = document.getElementById('storyUploadPlaceholder');
      const storyPreview = document.getElementById('storyPreview');
      const storyPreviewImage = document.getElementById('storyPreviewImage');
      const storyFileInput = document.getElementById('storyFileInput');
      const postStoryBtn = document.getElementById('postStoryBtn');
      const storyViewer = document.getElementById('storyViewer');
      const storyImage = document.getElementById('storyImage');
      const storyProgressBar = document.querySelector('.story-progress-bar');
      const closeStoryBtn = document.getElementById('closeStoryBtn');
      
      // Create story button
      createStoryBtn.addEventListener('click', () => {
        createStoryModal.classList.remove('hidden');
      });
      
      // Close create story modal
      closeCreateStoryModal.addEventListener('click', () => {
        createStoryModal.classList.add('hidden');
        storyPreview.classList.add('hidden');
        storyUploadPlaceholder.classList.remove('hidden');
        postStoryBtn.disabled = true;
      });
      
      // Story upload placeholder click
      storyUploadPlaceholder.addEventListener('click', () => {
        storyFileInput.click();
      });
      
      // Story file input change
      storyFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          storyPreviewImage.src = event.target.result;
          storyPreview.classList.remove('hidden');
          storyUploadPlaceholder.classList.add('hidden');
          postStoryBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      });
      
      // Post story
      postStoryBtn.addEventListener('click', () => {
        const file = storyFileInput.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64 = event.target.result;
          const type = file.type.split('/')[0]; // 'image' or 'video'
          
          socket.emit('uploadStory', {
            base64,
            type
          });
          
          createStoryModal.classList.add('hidden');
          storyPreview.classList.add('hidden');
          storyUploadPlaceholder.classList.remove('hidden');
          postStoryBtn.disabled = true;
        };
        reader.readAsDataURL(file);
      });
      
      // Close story viewer
      closeStoryBtn.addEventListener('click', () => {
        storyViewer.classList.add('hidden');
      });
      
      // ===== Video Calls =====
      const videoCallModal = document.getElementById('videoCallModal');
      const remoteVideo = document.getElementById('remoteVideo');
      const localVideo = document.getElementById('localVideo');
      const endCallBtn = document.getElementById('endCallBtn');
      const muteCallBtn = document.getElementById('muteCallBtn');
      const videoToggleBtn = document.getElementById('videoToggleBtn');
      const incomingCallModal = document.getElementById('incomingCallModal');
      const incomingCallFrom = document.getElementById('incomingCallFrom');
      const declineCallBtn = document.getElementById('declineCallBtn');
      const acceptCallBtn = document.getElementById('acceptCallBtn');
      const startAudioCallBtn = document.getElementById('startAudioCallBtn');
      const startVideoCallBtn = document.getElementById('startVideoCallBtn');
      
      let localStream;
      let peerConnection;
      let isCaller = false;
      let currentCallId = null;
      
      // Start audio call
      startAudioCallBtn.addEventListener('click', () => {
        if (currentChatUserId) {
          startCall(false);
        }
      });
      
      // Start video call
      startVideoCallBtn.addEventListener('click', () => {
        if (currentChatUserId) {
          startCall(true);
        }
      });
      
      // End call
      endCallBtn.addEventListener('click', () => {
        endCall();
      });
      
      // Toggle mute
      muteCallBtn.addEventListener('click', () => {
        if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            muteCallBtn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
          }
        }
      });
      
      // Toggle video
      videoToggleBtn.addEventListener('click', () => {
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            videoToggleBtn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
          }
        }
      });
      
      // Decline incoming call
      declineCallBtn.addEventListener('click', () => {
        socket.emit('callRejected', { callId: currentCallId });
        incomingCallModal.classList.add('hidden');
        currentCallId = null;
      });
      
      // Accept incoming call
      acceptCallBtn.addEventListener('click', async () => {
        incomingCallModal.classList.add('hidden');
        videoCallModal.classList.remove('hidden');
        
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
          
          // Create peer connection
          peerConnection = new RTCPeerConnection();
          
          // Add local stream to peer connection
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });
          
          // Handle remote stream
          peerConnection.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0];
          };
          
          // Create answer
          const offer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(offer);
          
          socket.emit('answerCall', {
            callId: currentCallId,
            answer: offer
          });
        } catch (err) {
          console.error('Error accepting call:', err);
          endCall();
        }
      });
      
      // Start a new call
      async function startCall(withVideo) {
        try {
          isCaller = true;
          videoCallModal.classList.remove('hidden');
          
          // Get user media
          localStream = await navigator.mediaDevices.getUserMedia({ 
            video: withVideo, 
            audio: true 
          });
          localVideo.srcObject = localStream;
          
          // Create peer connection
          peerConnection = new RTCPeerConnection();
          
          // Add local stream to peer connection
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });
          
          // Handle remote stream
          peerConnection.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0];
          };
          
          // Create offer
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          
          // Generate call ID
          currentCallId = Date.now().toString();
          
          // Emit call event
          socket.emit('callUser', {
            to: currentChatUserId,
            callId: currentCallId,
            offer,
            withVideo
          });
        } catch (err) {
          console.error('Error starting call:', err);
          endCall();
        }
      }
      
      // End current call
      function endCall() {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
        
        if (currentCallId) {
          if (isCaller) {
            socket.emit('endCall', { callId: currentCallId });
          }
          currentCallId = null;
        }
        
        videoCallModal.classList.add('hidden');
        remoteVideo.srcObject = null;
        localVideo.srcObject = null;
        isCaller = false;
      }
      
      // ===== Online users list =====
      socket.on('onlineUsers', users => {
        onlineUsers = users.filter(user => user.id !== userId);
        renderUsersList(onlineUsers);
        
        // If we have a current chat user, update their status
        if (currentChatUserId) {
          const user = onlineUsers.find(u => u.id === currentChatUserId);
          if (!user) {
            // User went offline
            document.querySelector('#chatHeader .text-xs').textContent = 'Offline';
          } else {
            document.querySelector('#chatHeader .text-xs').textContent = 'Online';
          }
        }
      });
      
      // ===== Stories updates =====
      socket.on('stories', stories => {
        storiesContainer.innerHTML = '';
        
        // Add create story button
        const createStoryItem = document.createElement('div');
        createStoryItem.className = 'story-item';
        createStoryItem.innerHTML = `
          <div class="story-inner">
            <i class="fas fa-plus text-gray-500"></i>
          </div>
        `;
        createStoryItem.addEventListener('click', () => {
          createStoryModal.classList.remove('hidden');
        });
        storiesContainer.appendChild(createStoryItem);
        
        // Add other stories
        stories.forEach(story => {
          const storyItem = document.createElement('div');
          storyItem.className = 'story-item';
          storyItem.innerHTML = `
            <div class="story-inner">
              <img src="${story.preview}" alt="${story.username}" class="story-image">
            </div>
          `;
          
          storyItem.addEventListener('click', () => {
            storyImage.src = story.mediaUrl;
            storyViewer.classList.remove('hidden');
            
            // Start progress bar
            let progress = 0;
            const duration = 5000; // 5 seconds per story
            const interval = 50; // update every 50ms
            const increment = (interval / duration) * 100;
            
            const timer = setInterval(() => {
              progress += increment;
              storyProgressBar.style.width = `${progress}%`;
              
              if (progress >= 100) {
                clearInterval(timer);
                storyViewer.classList.add('hidden');
                storyProgressBar.style.width = '0%';
              }
            }, interval);
            
            // Pause on hover
            storyViewer.addEventListener('mouseenter', () => {
              clearInterval(timer);
            });
            
            storyViewer.addEventListener('mouseleave', () => {
              const remaining = duration - (progress / 100 * duration);
              const newInterval = setInterval(() => {
                progress += increment;
                storyProgressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                  clearInterval(newInterval);
                  storyViewer.classList.add('hidden');
                  storyProgressBar.style.width = '0%';
                }
              }, interval);
            });
          });
          
          storiesContainer.appendChild(storyItem);
        });
      });
      
      // Render users list with search filtering
      function renderUsersList(users) {
        usersList.innerHTML = '';
        
        if (users.length === 0) {
          usersList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              Nenhum contato online
            </div>
          `;
          return;
        }
        
        users.forEach(user => {
          const li = document.createElement('li');
          li.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer transition flex items-center';
          li.dataset.id = user.id;
          
          li.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3">
              <i class="fas fa-user"></i>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">${user.username}</p>
              <p class="text-xs text-gray-500">Online</p>
            </div>
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
          `;
          
          li.addEventListener('click', () => selectUser(user.id, user.username, li));
          usersList.appendChild(li);
        });
      }
      
      // Search functionality
      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredUsers = onlineUsers.filter(user => 
          user.username.toLowerCase().includes(searchTerm)
        );
        renderUsersList(filteredUsers);
      });
      
      // Select user for private chat
      function selectUser(id, username, element) {
        currentChatUserId = id;
        currentChatUsername = username;
        
        // Update UI
        Array.from(usersList.children).forEach(li => {
          li.classList.remove('bg-gray-100');
        });
        
        if (element) {
          element.classList.add('bg-gray-100');
        }
        
        chatTitle.textContent = username;
        document.querySelector('#chatHeader .text-xs').textContent = 'Online';
        
        // Clear and update messages container
        messagesContainer.innerHTML = `
          <div class="text-center text-gray-500 text-sm py-8">
            Carregando mensagens...
          </div>
        `;
        
        typingIndicator.textContent = '';
        
        // On mobile, show chat area and hide user list
        if (window.innerWidth <= 768) {
          usersListContainer.style.display = 'none';
          chatArea.style.display = 'flex';
        }
        
        // Join the chat room
        socket.emit('join', { to: id });
      }
      
      // ===== Message history =====
      socket.on('history', ({ messages, pinnedMessage }) => {
        if (messages.length === 0 && !pinnedMessage) {
          messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-8">
              Nenhuma mensagem ainda. Comece a conversa!
            </div>
          `;
          return;
        }
        
        messagesContainer.innerHTML = '';
        
        // Show pinned message if exists
        if (pinnedMessage) {
          pinnedMessageContainer.classList.remove('hidden');
          pinnedMessageContent.textContent = pinnedMessage.text;
        } else {
          pinnedMessageContainer.classList.add('hidden');
        }
        
        messages.forEach(msg => appendMessage(msg));
        scrollToBottom();
      });
      
      // ===== New message received =====
      socket.on('message', msg => {
        if (
          msg.from === currentChatUserId ||
          (msg.from === userId && msg.to === currentChatUserId)
        ) {
          appendMessage(msg);
          scrollToBottom();
          
          // Add notification sound
          if (msg.from !== userId) {
            playNotificationSound();
          }
        }
      });
      
      // ===== Media message received =====
      socket.on('mediaMessage', msg => {
        if (
          msg.from === currentChatUserId ||
          (msg.from === userId && msg.to === currentChatUserId)
        ) {
          appendMediaMessage(msg);
          scrollToBottom();
          
          // Add notification sound
          if (msg.from !== userId) {
            playNotificationSound();
          }
        }
      });
      
      // ===== Message reaction received =====
      socket.on('reaction', ({ messageId, emoji }) => {
        const messageElement = document.querySelector(`.message-container[data-id="${messageId}"]`);
        if (messageElement) {
          // Remove existing reaction if any
          const existingReaction = messageElement.querySelector('.message-reaction');
          if (existingReaction) {
            existingReaction.remove();
          }
          
          // Add new reaction
          if (emoji) {
            const reactionElement = document.createElement('div');
            reactionElement.className = 'message-reaction';
            reactionElement.textContent = emoji;
            messageElement.appendChild(reactionElement);
          }
        }
      });
      
      // ===== Pinned message update =====
      socket.on('pinnedMessage', (msg) => {
        if (msg) {
          pinnedMessageContainer.classList.remove('hidden');
          pinnedMessageContent.textContent = msg.text;
        } else {
          pinnedMessageContainer.classList.add('hidden');
        }
      });
      
      // ===== Self-destruct message timer =====
      socket.on('selfDestructTimer', ({ messageId, secondsLeft }) => {
        const messageElement = document.querySelector(`.message-container[data-id="${messageId}"]`);
        if (messageElement) {
          const timerElement = messageElement.querySelector('.self-destruct-timer');
          if (timerElement) {
            timerElement.textContent = `Apagando em ${secondsLeft}s`;
            
            if (secondsLeft <= 0) {
              messageElement.style.opacity = '0.5';
              timerElement.textContent = 'Apagada';
            }
          }
        }
      });
      
      // ===== Incoming call =====
      socket.on('incomingCall', ({ from, username, callId, offer, withVideo }) => {
        currentCallId = callId;
        incomingCallFrom.textContent = `De: ${username}`;
        incomingCallModal.classList.remove('hidden');
        
        // Set up peer connection when call is accepted
        async function handleAnswer(answer) {
          try {
            await peerConnection.setRemoteDescription(answer);
          } catch (err) {
            console.error('Error setting remote description:', err);
            endCall();
          }
        }
        
        // Handle call accepted
        socket.on('callAccepted', async ({ answer }) => {
          await handleAnswer(answer);
        });
      });
      
      // ===== Call answered =====
      socket.on('callAnswered', async ({ answer }) => {
        try {
          await peerConnection.setRemoteDescription(answer);
        } catch (err) {
          console.error('Error setting remote description:', err);
          endCall();
        }
      });
      
      // ===== Call rejected =====
      socket.on('callRejected', () => {
        alert(`${currentChatUsername} rejeitou sua chamada.`);
        endCall();
      });
      
      // ===== Call ended =====
      socket.on('callEnded', () => {
        alert(`${currentChatUsername} encerrou a chamada.`);
        endCall();
      });
      
      // ===== ICE candidates =====
      socket.on('iceCandidate', ({ candidate }) => {
        if (peerConnection && candidate) {
          peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });
      
      // Play notification sound
      function playNotificationSound() {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Audio play failed:', e));
      }
      
      // ===== Typing indicator =====
      socket.on('typing', ({ from, isTyping }) => {
        if (from === currentChatUserId) {
          if (isTyping) {
            typingIndicator.innerHTML = `
              <span class="flex items-center">
                ${currentChatUsername} está digitando
                <span class="typing-dot ml-1"></span>
                <span class="typing-dot ml-1"></span>
                <span class="typing-dot ml-1"></span>
              </span>
            `;
          } else {
            typingIndicator.textContent = 'Online';
          }
        }
      });
      
      // ===== Send message =====
      msgForm.addEventListener('submit', e => {
        e.preventDefault();
        const text = msgInput.value.trim();
        if (!text || !currentChatUserId) return;
        
        if (selfDestructEnabled) {
          socket.emit('selfDestructMessage', { 
            to: currentChatUserId, 
            text, 
            seconds: selfDestructSeconds 
          });
          selfDestructEnabled = false;
          selfDestructBtn.classList.remove('text-indigo-600');
        } else {
          socket.emit('message', { to: currentChatUserId, text });
        }
        
        msgInput.value = '';
        socket.emit('typing', { to: currentChatUserId, isTyping: false });
        msgInput.focus();
      });
      
      // ===== Typing event emission =====
      msgInput.addEventListener('input', () => {
        if (!currentChatUserId) return;
        
        socket.emit('typing', { to: currentChatUserId, isTyping: true });
        clearTimeout(typingTimeout);
        
        typingTimeout = setTimeout(() => {
          socket.emit('typing', { to: currentChatUserId, isTyping: false });
        }, 1000);
      });
      
      // ===== Helpers =====
      function appendMessage(msg) {
        // Remove the loading message if it exists
        if (messagesContainer.children.length === 1 && 
              messagesContainer.children[0].classList.contains('text-center')) {
          messagesContainer.innerHTML = '';
        }
        
        const isSent = msg.from === userId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-container relative ${isSent ? 'flex justify-end' : 'flex justify-start'} mb-3 message-animation`;
        messageDiv.dataset.id = msg.id;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `relative max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isSent ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}`;
        bubbleDiv.textContent = msg.text;
        
        // Add reaction button
        const reactionBtn = document.createElement('button');
        reactionBtn.className = 'reaction-btn';
        reactionBtn.innerHTML = '<i class="fas fa-smile"></i>';
        messageDiv.appendChild(reactionBtn);
        
        // Add reactions container
        const reactionsContainer = document.createElement('div');
        reactionsContainer.className = 'reactions-container';
        reactionsContainer.innerHTML = `
          <span class="reaction-emoji">👍</span>
          <span class="reaction-emoji">😂</span>
          <span class="reaction-emoji">❤️</span>
          <span class="reaction-emoji">😮</span>
          <span class="reaction-emoji">😢</span>
          <span class="reaction-emoji">👏</span>
        `;
        messageDiv.appendChild(reactionsContainer);
        
        // Add pin button for received messages
        if (!isSent) {
          const pinBtn = document.createElement('button');
          pinBtn.className = 'pin-btn absolute -left-2 top-1/2 transform -translate-y-1/2 bg-white w-6 h-6 rounded-full flex items-center justify-center shadow-md text-gray-500 hover:text-indigo-600';
          pinBtn.innerHTML = '<i class="fas fa-thumbtack text-xs"></i>';
          messageDiv.appendChild(pinBtn);
        }
        
        // Add existing reaction if any
        if (msg.reaction) {
          const reactionElement = document.createElement('div');
          reactionElement.className = 'message-reaction';
          reactionElement.textContent = msg.reaction;
          messageDiv.appendChild(reactionElement);
        }
        
        // Add self-destruct timer if applicable
        if (msg.selfDestruct) {
          const timerElement = document.createElement('div');
          timerElement.className = 'self-destruct-timer';
          timerElement.textContent = `Apagando em ${msg.selfDestruct}s`;
          messageDiv.appendChild(timerElement);
        }
        
        const timeSpan = document.createElement('span');
        timeSpan.className = `block text-xs mt-1 ${isSent ? 'text-indigo-200' : 'text-gray-500'}`;
        timeSpan.textContent = formatTime(msg.timestamp || msg.createdAt);
        
        bubbleDiv.appendChild(timeSpan);
        messageDiv.appendChild(bubbleDiv);
        messagesContainer.appendChild(messageDiv);
        
        // Setup reaction buttons
        setupReactionButtons(messageDiv, msg.id);
        
        // Setup pin button
        setupPinButton(messageDiv, msg.id);
      }
      
      function appendMediaMessage(msg) {
        // Remove the loading message if it exists
        if (messagesContainer.children.length === 1 && 
              messagesContainer.children[0].classList.contains('text-center')) {
          messagesContainer.innerHTML = '';
        }
        
        const isSent = msg.from === userId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-container relative ${isSent ? 'flex justify-end' : 'flex justify-start'} mb-3 message-animation`;
        messageDiv.dataset.id = msg.id;
        
        const mediaContainer = document.createElement('div');
        mediaContainer.className = `relative max-w-xs lg:max-w-md rounded-lg overflow-hidden ${isSent ? 'bg-indigo-100' : 'bg-gray-100'}`;
        
        if (msg.type === 'image') {
          const img = document.createElement('img');
          img.src = msg.base64;
          img.className = 'w-full h-auto max-h-80 object-cover';
          mediaContainer.appendChild(img);
        } else if (msg.type === 'video') {
          const video = document.createElement('video');
          video.src = msg.base64;
          video.controls = true;
          video.className = 'w-full h-auto max-h-80';
          mediaContainer.appendChild(video);
        }
        
        // Add reaction button
        const reactionBtn = document.createElement('button');
        reactionBtn.className = 'reaction-btn';
        reactionBtn.innerHTML = '<i class="fas fa-smile"></i>';
        messageDiv.appendChild(reactionBtn);
        
        // Add reactions container
        const reactionsContainer = document.createElement('div');
        reactionsContainer.className = 'reactions-container';
        reactionsContainer.innerHTML = `
          <span class="reaction-emoji">👍</span>
          <span class="reaction-emoji">😂</span>
          <span class="reaction-emoji">❤️</span>
          <span class="reaction-emoji">😮</span>
          <span class="reaction-emoji">😢</span>
          <span class="reaction-emoji">👏</span>
        `;
        messageDiv.appendChild(reactionsContainer);
        
        // Add pin button for received messages
        if (!isSent) {
          const pinBtn = document.createElement('button');
          pinBtn.className = 'pin-btn absolute -left-2 top-1/2 transform -translate-y-1/2 bg-white w-6 h-6 rounded-full flex items-center justify-center shadow-md text-gray-500 hover:text-indigo-600';
          pinBtn.innerHTML = '<i class="fas fa-thumbtack text-xs"></i>';
          messageDiv.appendChild(pinBtn);
        }
        
        // Add existing reaction if any
        if (msg.reaction) {
          const reactionElement = document.createElement('div');
          reactionElement.className = 'message-reaction';
          reactionElement.textContent = msg.reaction;
          messageDiv.appendChild(reactionElement);
        }
        
        // Add self-destruct timer if applicable
        if (msg.selfDestruct) {
          const timerElement = document.createElement('div');
          timerElement.className = 'self-destruct-timer';
          timerElement.textContent = `Apagando em ${msg.selfDestruct}s`;
          messageDiv.appendChild(timerElement);
        }
        
        const timeSpan = document.createElement('span');
        timeSpan.className = `absolute bottom-2 right-2 text-xs px-2 py-1 rounded-full ${isSent ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`;
        timeSpan.textContent = formatTime(msg.timestamp || msg.createdAt);
        
        mediaContainer.appendChild(timeSpan);
        messageDiv.appendChild(mediaContainer);
        messagesContainer.appendChild(messageDiv);
        
        // Setup reaction buttons
        setupReactionButtons(messageDiv, msg.id);
        
        // Setup pin button
        setupPinButton(messageDiv, msg.id);
      }
      
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Focus message input when chat is selected
      msgInput.addEventListener('focus', () => {
        if (currentChatUserId) {
          socket.emit('typing', { to: currentChatUserId, isTyping: true });
        }
      });
      
      msgInput.addEventListener('blur', () => {
        if (currentChatUserId) {
          socket.emit('typing', { to: currentChatUserId, isTyping: false });
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentChatUserId) {
          // Clear current chat selection
          currentChatUserId = null;
          currentChatUsername = null;
          chatTitle.textContent = 'Selecione um contato';
          messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-8">
              Selecione um contato para começar a conversar
            </div>
          `;
          
          // Remove active state from all users
          Array.from(usersList.children).forEach(li => {
            li.classList.remove('bg-gray-100');
          });
          
          // On mobile, show user list and hide chat area
          if (window.innerWidth <= 768) {
            usersListContainer.style.display = 'block';
            chatArea.style.display = 'none';
          }
        }
      });
      
      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          // On desktop, show both panels
          usersListContainer.style.display = 'block';
          chatArea.style.display = 'flex';
        } else if (!currentChatUserId) {
          // On mobile with no chat selected, show user list
          usersListContainer.style.display = 'block';
          chatArea.style.display = 'none';
        } else {
          // On mobile with chat selected, show chat
          usersListContainer.style.display = 'none';
          chatArea.style.display = 'flex';
        }
      });
      
      // Initialize WebRTC
      if (navigator.mediaDevices && RTCPeerConnection) {
        // Set up peer connection events
        function setupPeerConnection() {
          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit('iceCandidate', {
                to: currentChatUserId,
                callId: currentCallId,
                candidate: event.candidate
              });
            }
          };
          
          peerConnection.oniceconnectionstatechange = () => {
            if (peerConnection.iceConnectionState === 'disconnected') {
              endCall();
            }
          };
        }
        
        // Handle incoming ICE candidates
        socket.on('iceCandidate', ({ candidate }) => {
          if (peerConnection && candidate) {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          }
        });
      } else {
        // Hide call buttons if WebRTC is not supported
        startAudioCallBtn.style.display = 'none';
        startVideoCallBtn.style.display = 'none';
      }
      
      return {
        socket,
        currentChatUserId,
        currentChatUsername,
        onlineUsers
      };
    })();
  </script>
</body>
</html>